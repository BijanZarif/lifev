# -*- autoconf -*-
# 
#
AC_INIT(life, 0.1.0, christophe.prudhomme@epfl.ch)
LIFE_PACKAGE=life
LIFE_VERSION=0.1.0

PACKAGE=$LIFE_PACKAGE
VERSION=$LIFE_VERSION

AC_SUBST(LIFE_PACKAGE)
AC_SUBST(LIFE_VERSION)

AC_CONFIG_AUX_DIR(admin)

dnl What the current system and host
AC_CANONICAL_HOST
AC_CANONICAL_SYSTEM


AM_INIT_AUTOMAKE(${LIFE_PACKAGE}, ${LIFE_VERSION} )
AM_CONFIG_HEADER(lifeconfig.h)



# check for a C compiler
AC_PROG_CC( gcc )
AC_PROG_CC_C_O
AC_PROG_CXX( g++ )
AC_PROG_F77( g77 )
AC_PROG_F77_C_O

dnl Check debugging mode for compilation.
AC_ARG_ENABLE(debug,
  AC_HELP_STRING([--enable-debug],[enables debugging mode (default=no)]),
  [
   if test $enableval = "no";
     then ac_use_debug_code="no"
     else ac_use_debug_code="yes"
   fi
  ], [ac_use_debug_code="no"])

AC_ARG_ENABLE(opt,
  AC_HELP_STRING([--enable-opt],[enables optimization mode (default=no)]),
  [
   if test $enableval = "no";
     then ac_use_opt_code="no"
     else ac_use_opt_code="yes"
   fi
  ], [ac_use_opt_code="no"])

if test $ac_use_debug_code = "yes" -a $ac_use_opt_code = "yes"
then
  AC_MSG_ERROR(Cannot use --enable-debug and --enable-opt at the same time!)
fi

if test $ac_use_debug_code = "yes"; then
 CXXFLAGS="-g3 -O0 -Wall"
 CFLAGS="-g3 -O0 -Wall"
else 
 if test $ac_use_opt_code = "yes"; then
  CXXFLAGS="-O2 -funroll-all-loops -fargument-noalias-global -fno-gcse -Wall"
  CFLAGS="-O2 -funroll-all-loops -fargument-noalias-global -fno-gcse -Wall"
  CPPFLAGS="-DNDEBUG"
 fi
fi

# check for libtool
AC_PROG_LIBTOOL
AC_ARG_WITH([aztec], 
 AC_HELP_STRING([--with-aztec],[tell where aztec resides]),
 [
  # AZTEC check
  AC_MSG_CHECKING([Aztec headers files presence])
  ac_aztec_includedirs="$REPOSITORY/$ARCH/include/Aztec_LifeV/ /usr/include /usr/local/include"
  ac_aztec_includedir="$withval/include"
  AC_MSG_RESULT([$ac_aztec_includedir])
  CXXFLAGS="-I$ac_aztec_includedir ${CXXFLAGS}"

  AC_MSG_CHECKING([Aztec libraries presence])
  ac_aztec_libdir="$withval/lib"
  LDFLAGS="${LDFLAGS} -L${ac_aztec_libdir}"
  aztec_libs="-laztec"
  AC_SUBST(aztec_libs)
  AC_MSG_RESULT([$aztec_libs])
 ],
 [
  # AZTEC check
  AC_MSG_CHECKING([Aztec headers files presence])
  ac_aztec_includedirs="$REPOSITORY/$ARCH/include/Aztec_LifeV/ /usr/include /usr/local/include"
  AC_FIND_FILE("az_aztec.h",$ac_aztec_includedirs , ac_aztec_includedir)
  AC_MSG_RESULT([$ac_aztec_includedir])
  CXXFLAGS="-I$ac_aztec_includedir ${CXXFLAGS}"

  AC_MSG_CHECKING([Aztec libraries presence])
  ac_aztec_libdirs="$REPOSITORY/$ARCH/lib$AFFIX/Aztec_LifeV/ /usr/lib /usr/local/lib"
  AC_FIND_FILE("libaztec.a", $ac_aztec_libdirs, ac_aztec_libdir)
  # echo $ac_aztec_libdir
  LDFLAGS="${LDFLAGS} -L${ac_aztec_libdir}"
  aztec_libs="-laztec"
  AC_SUBST(aztec_libs)
  AC_MSG_RESULT([$aztec_libs])
 ])

all_includes="-I\$(top_srcdir)/life/lifecore -I\$(top_srcdir)/life/lifearray  -I\$(top_srcdir)/life/lifemesh -I\$(top_srcdir)/life/lifealg  -I\$(top_srcdir)/life/lifefem -I\$(top_srcdir)/life/lifesolver -I\$(top_srcdir)/life/lifefilters"
AC_SUBST(all_includes)

CPPFLAGS="-DTHREEDIM ${CPPFLAGS}"

CXXFLAGS="-Wall ${CXXFLAGS}"


# life_libs="\$(top_builddir)/life/lifefilters/liblifefilters.la  \$(top_builddir)/life/lifesolver/liblifesolver.la \$(top_builddir)/life/lifefem/liblifefem.la \$(top_builddir)/life/lifealg/liblifealg.la \$(top_builddir)/life/lifemesh/liblifemesh.la \$(top_builddir)/life/lifearray/liblifearray.la \$(top_builddir)/life/lifecore/liblifecore.la"

life_libs="\$(top_builddir)/life/lifefilters/liblifefilters.la  \$(top_builddir)/life/lifefem/liblifefem.la \$(top_builddir)/life/lifealg/liblifealg.la \$(top_builddir)/life/lifemesh/liblifemesh.la \$(top_builddir)/life/lifecore/liblifecore.la"

AC_SUBST(life_libs)

